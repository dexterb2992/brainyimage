!function(e){e(window,document,window.jQuery)}(function(e,a,r){function n(e,a){var n='<div class="alert alert-'+(e?"success":"danger")+'">';n+='<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>',n+=a,n+="</div>",r(n).insertBefore(r("#img-zone"))}function t(e,a,r,n){e=(e+"").replace(/[^0-9+\-Ee.]/g,"");var t=isFinite(+e)?+e:0,s=isFinite(+a)?Math.abs(a):0,i="undefined"==typeof n?",":n,o="undefined"==typeof r?".":r,d="",l=function(e,a){var r=Math.pow(10,a);return""+(Math.round(e*r)/r).toFixed(a)};return d=(s?l(t,s):""+Math.round(t)).split("."),d[0].length>3&&(d[0]=d[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,i)),(d[1]||"").length<s&&(d[1]=d[1]||"",d[1]+=new Array(s-d[1].length+1).join("0")),d.join(o)}function s(e){var a="byte";return e>=1073741824?(e=t(e/1073741824,2),a="GB"):e>=1048576?(e=t(e/1048576,2),a="MB"):e>=1024?(e=t(e/1024,2),a="KB"):e>1?a="bytes":1==e?a="byte":e="0",e+" "+a}function i(e,a){var s=a.find(".progress-bar"),i=new FormData;i.append("q","upload"),i.append("img_file[]",e),r("#results").append(a),function(){r.ajax({url:"process.php",type:"post",data:i,assync:!1,dataType:"json",processData:!1,contentType:!1,progress:function(e){if(e.lengthComputable){var a=e.loaded/e.total*100;console.log("Upload progres.."+a+"%"),s.css({width:a+"%"}).html(t(a)+"%")}else console.warn("1. Content Length not reported!")},success:function(e){e.success?(s.css({width:"100%"}).html("Compressingg").removeClass("bg-info").addClass("bg-success"),o(e,a)):n(!1,"An error has occured while uploading photo.")},error:function(e){console.warn(e),n(!1,"An error has occured while uploading photo.")}})}()}function o(e,a){var t=a.find(".progress-bar");!function(s){r.ajax({url:"process.php",type:"post",assync:!1,data:{q:"compress",src:e.url,filename:e.filename},dataType:"json",progress:function(e){if(e.lengthComputable){var a=e.loaded/e.total*100;t.css({width:a+"%"}).html("Compressing")}else console.warn("2. Content Length not reported!")},success:function(e){t.css({width:"100%"}).html("Finished").removeClass("progress-bar-animated").removeClass("progress-bar-striped"),e.success?(a.find(".size-after").html(e.output.size),a.find(".size-diff").html("-"+e.output.diff),a.find(".download-link").attr("href",e.output.url).removeClass("disabled").html('<i class="fa fa-cloud-download"></i> Download').attr("data-orig-image",e.input.url),a.find(".btn-retry").attr("data-url",e.output.url).removeClass("disabled").html('<i class="fa fa-refresh"></i> Retry ')):e.hasOwnProperty("error")&&e.hasOwnProperty("error_description")?(a.find(".size-after").html(e.error_description).removeClass("badge-primary").addClass("badge-danger"),a.find(".download-link").remove(),n(!1,e.error)):n(!1,"An error has occured while compressing your image.")},error:function(){n(!1,"An error has occured while requesting to compress an image.")}})}()}function d(e,a){var n=r("<div class='entry' id='entry_"+e[a].name+"'></div>"),t=r('<div class="row"></div>'),i=r('<div class="col-md-3 file-before"></div>'),o=r('<div class="col-md-6 row file-progress"><div class="col-md-3 col-sm-3"></div><div class="col-md-6 col-sm-6"></div><div class="col-md-3 col-sm-3"></div>NaN'),d=r('<div class="col-md-3 file-after"></div>'),l=s(e[a].size);e[a].hasOwnProperty("oldSize")&&(l=e[a].oldSize);var c=r('<span class="size-before badge badge-info">'+l+"</span>"),p=r('<span class="size-after badge badge-primary"></span>'),f=r('<span class="size-diff badge badge-danger"></span>'),u=r('<span class="progress"><span id="progress_'+e[a].name+'" class="progress-bar progress-bar-striped bg-info progress-bar-animated" role="progressbar" aria-valuenow="0%" style="width: 0%;height: 19px;" aria-valuemin="0" aria-valuemax="100"></span></span>'),g=r('<a class="disabled download-link btn btn-sm btn-warning" href="javascript:void(0);" download><a><a title="Optimize again" class="disabled btn-retry btn btn-sm btn-success" href="javascript:void(0);"></a>'),m=r('<a href="javascript:void(0)" title="View image difference" class="label text-white view-image-diff pull-right"><i class="fa fa-eye"></i></a>');return i.append(r('<span title="'+e[a].name+'">'+e[a].name+"</span>")),o.children("div:first").append(c),o.children("div:nth-child(2)").append(u),o.children("div:last").append(p),o.children("div:last").append(m),d.append(g),d.append(f),t.append(i),t.append(o),t.append(d),n.append(t),n}function l(e,a){if(e.files&&e.files[0]){var r=new FileReader;r.onload=function(e){a.attr("src",e.target.result)},r.readAsDataURL(e.files[0])}}r(function(){function n(e){e.ondragover=function(){return!1},e.ondragend=function(){return!1},e.ondrop=function(e){e.preventDefault(),r("#results").removeClass("hidden");for(var a=e.dataTransfer.files,n=a.length-1;n>=0;n--)$entry=d(a,n),i(a[n],$entry),$entry=""}}r(".alert.alert-success").length>0&&setTimeout(function(){r(".alert.alert-success").fadeOut(function(){r(this).remove()})},7e3);var t=a.getElementById("img-zone"),s={filereader:"undefined"!=typeof FileReader,zone:"draggable"in a.createElement("span"),formdata:!!e.FormData};s.zone?null!=t&&n(t):alert("Drag & Drop isn't supported, use Open File Browser to upload photos."),r(a).on("change","#file_handle",function(){r("#results").removeClass("hidden");for(var e=this.files,a=e.length-1;a>=0;a--)$entry=d(e,a),i(e[a],$entry),$entry=""}),r(a).on("click",".btn-retry",function(){var e=r(this),a=e.parents(".entry:first"),n=a.find(".size-after").text(),t=[{name:e.attr("data-url"),oldSize:n}],s=d(t,0);a.append(s);var i={url:e.attr("data-url"),filename:"**from_url**"};o(i,s)}),r(a).on("click",".view-image-diff",function(){var e=r(this),a=r("#image_difference_modal"),n=a.find(".image-original"),t=a.find(".image-optimized"),s=e.parents(".entry:first"),i=s.find(".download-link");n.find("img").attr("src",i.attr("data-orig-image")),t.find("img").attr("src",i.attr("href")),n.find(".size").html(s.find(".size-before").parent("div").html());var o=s.find(".size-after").parent("div").clone();o.find(".view-image-diff").remove(),t.find(".size").html(o.html()),a.modal()}),r("#btn_avatar").on("change",function(){l(this,r("#avatar_preview"))}),r(".btn-file").click(function(){r("#file_handle").click()}),function(e,a,r){var n="onprogress"in e.ajaxSettings.xhr();if(n){var t=e.ajaxSettings.xhr;e.ajaxSettings.xhr=function(){var e=t();return e instanceof a.XMLHttpRequest&&e.addEventListener("progress",this.progress,!1),e.upload&&e.upload.addEventListener("progress",this.progress,!1),e}}}(jQuery,e)})});
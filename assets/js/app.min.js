!function(e){e(window,document,window.jQuery)}(function(e,a,r){function n(e,a){var n='<div class="alert alert-'+(e?"success":"danger")+'">';n+='<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>',n+=a,n+="</div>",r(n).insertBefore(r("#img-zone"))}function s(e,a,r,n){e=(e+"").replace(/[^0-9+\-Ee.]/g,"");var s=isFinite(+e)?+e:0,t=isFinite(+a)?Math.abs(a):0,i="undefined"==typeof n?",":n,o="undefined"==typeof r?".":r,d="",l=function(e,a){var r=Math.pow(10,a);return""+(Math.round(e*r)/r).toFixed(a)};return d=(t?l(s,t):""+Math.round(s)).split("."),d[0].length>3&&(d[0]=d[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,i)),(d[1]||"").length<t&&(d[1]=d[1]||"",d[1]+=new Array(t-d[1].length+1).join("0")),d.join(o)}function t(e){var a="byte";return e>=1073741824?(e=s(e/1073741824,2),a="GB"):e>=1048576?(e=s(e/1048576,2),a="MB"):e>=1024?(e=s(e/1024,2),a="KB"):e>1?a="bytes":1==e?a="byte":e="0",e+" "+a}function i(e,a){var t=a.find(".progress-bar"),i=new FormData;i.append("q","upload"),i.append("img_file[]",e),r("#results").append(a),function(){r.ajax({url:"process.php",type:"post",data:i,assync:!1,dataType:"json",processData:!1,contentType:!1,progress:function(e){if(e.lengthComputable){var a=e.loaded/e.total*100;console.log("Upload progres.."+a+"%"),t.css({width:a+"%"}).html(s(a)+"%")}else console.warn("1. Content Length not reported!")},success:function(e){e.success?(t.css({width:"100%"}).html("Compressingg").removeClass("bg-info").addClass("bg-success"),o(e,a)):n(!1,"An error has occured while uploading photo.")},error:function(e){console.warn(e),n(!1,"An error has occured while uploading photo.")}})}()}function o(e,a){var s=a.find(".progress-bar");!function(t){r.ajax({url:"process.php",type:"post",assync:!1,data:{q:"compress",src:e.url,filename:e.filename},dataType:"json",progress:function(e){if(e.lengthComputable){var a=e.loaded/e.total*100;s.css({width:a+"%"}).html("Compressing")}else console.warn("2. Content Length not reported!")},success:function(e){s.css({width:"100%"}).html("Finished").removeClass("progress-bar-animated").removeClass("progress-bar-striped"),e.success?(a.find(".size-after").html(e.output.size),a.find(".size-diff").html("-"+e.output.diff),a.find(".download-link").attr("href",e.output.url).removeClass("disabled").html('<i class="fa fa-cloud-download"></i> Download').attr("data-orig-image",e.input.url),a.find(".btn-retry").attr("data-url",e.output.url).removeClass("disabled").html('<i class="fa fa-refresh"></i> Retry ')):e.hasOwnProperty("error")&&e.hasOwnProperty("error_description")?(a.find(".size-after").html(e.error_description).removeClass("badge-primary").addClass("badge-danger"),a.find(".download-link").remove(),n(!1,e.error)):n(!1,"An error has occured while compressing your image.")},error:function(){n(!1,"An error has occured while requesting to compress an image.")}})}()}function d(e,a){var n=r("<div class='entry' id='entry_"+e[a].name+"'></div>"),s=r('<div class="row"></div>'),i=r('<div class="col-md-3 file-before"></div>'),o=r('<div class="col-md-6 row file-progress"><div class="col-md-3 col-sm-3"></div><div class="col-md-6 col-sm-6"></div><div class="col-md-3 col-sm-3"></div>NaN'),d=r('<div class="col-md-3 file-after"></div>'),l=t(e[a].size);e[a].hasOwnProperty("oldSize")&&(l=e[a].oldSize);var p=r('<span class="size-before badge badge-info">'+l+"</span>"),c=r('<span class="size-after badge badge-primary"></span>'),f=r('<span class="size-diff badge badge-danger"></span>'),u=r('<span class="progress"><span id="progress_'+e[a].name+'" class="progress-bar progress-bar-striped bg-info progress-bar-animated" role="progressbar" aria-valuenow="0%" style="width: 0%;height: 19px;" aria-valuemin="0" aria-valuemax="100"></span></span>'),g=r('<a class="disabled download-link btn btn-sm btn-warning" href="javascript:void(0);" download><a><a title="Optimize again" class="disabled btn-retry btn btn-sm btn-success" href="javascript:void(0);"></a>'),m=r('<a href="javascript:void(0)" title="View image difference" class="label text-white view-image-diff pull-right"><i class="fa fa-eye"></i></a>');return i.append(r('<span title="'+e[a].name+'">'+e[a].name+"</span>")),o.children("div:first").append(p),o.children("div:nth-child(2)").append(u),o.children("div:last").append(c),o.children("div:last").append(m),d.append(g),d.append(f),s.append(i),s.append(o),s.append(d),n.append(s),n}r(function(){function n(e){e.ondragover=function(){return!1},e.ondragend=function(){return!1},e.ondrop=function(e){e.preventDefault(),r("#results").removeClass("hidden");for(var a=e.dataTransfer.files,n=a.length-1;n>=0;n--)$entry=d(a,n),i(a[n],$entry),$entry=""}}var s=a.getElementById("img-zone"),t={filereader:"undefined"!=typeof FileReader,zone:"draggable"in a.createElement("span"),formdata:!!e.FormData};t.zone?n(s):alert("Drag & Drop isn't supported, use Open File Browser to upload photos."),r(a).on("change","#file_handle",function(){r("#results").removeClass("hidden");for(var e=this.files,a=e.length-1;a>=0;a--)$entry=d(e,a),i(e[a],$entry),$entry=""}),r(a).on("click",".btn-retry",function(){var e=r(this),a=e.parents(".entry:first"),n=a.find(".size-after").text(),s=[{name:e.attr("data-url"),oldSize:n}],t=d(s,0);a.append(t);var i={url:e.attr("data-url"),filename:"**from_url**"};o(i,t)}),r(a).on("click",".view-image-diff",function(){var e=r(this),a=r("#image_difference_modal"),n=a.find(".image-original"),s=a.find(".image-optimized"),t=e.parents(".entry:first"),i=t.find(".download-link");n.find("img").attr("src",i.attr("data-orig-image")),s.find("img").attr("src",i.attr("href")),n.find(".size").html(t.find(".size-before").parent("div").html());var o=t.find(".size-after").parent("div").clone();o.find(".view-image-diff").remove(),s.find(".size").html(o.html()),a.modal()}),r(".btn-file").click(function(){r("#file_handle").click()}),function(e,a,r){var n="onprogress"in e.ajaxSettings.xhr();if(n){var s=e.ajaxSettings.xhr;e.ajaxSettings.xhr=function(){var e=s();return e instanceof a.XMLHttpRequest&&e.addEventListener("progress",this.progress,!1),e.upload&&e.upload.addEventListener("progress",this.progress,!1),e}}}(jQuery,e)})});